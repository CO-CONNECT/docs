
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.9">
    
    
      
        <title>LocalFunctions - CO-CONNECT Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/custom.css">
    
      <link rel="stylesheet" href="../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../css/pandas-dataframe.css">
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="co-connect" data-md-color-primary="" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CO-CONNECT Docs" class="md-header__button md-logo" aria-label="CO-CONNECT Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CO-CONNECT Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              LocalFunctions
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CO-CONNECT Docs" class="md-nav__button md-logo" aria-label="CO-CONNECT Docs" data-md-component="logo">
      
  <img src="../../images/favicon.png" alt="logo">

    </a>
    CO-CONNECT Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Azure Functions
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Azure Functions" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Azure Functions
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          LocalFunctions
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        LocalFunctions
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-functions-basics" class="md-nav__link">
    Azure Functions Basics
  </a>
  
    <nav class="md-nav" aria-label="Azure Functions Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-functions-in-co-connect" class="md-nav__link">
    Azure Functions in Co-Connect
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-functions-queues" class="md-nav__link">
    Azure Functions Queues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-azure-functions-locally" class="md-nav__link">
    Running Azure Functions Locally
  </a>
  
    <nav class="md-nav" aria-label="Running Azure Functions Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-an-nlp-task" class="md-nav__link">
    Running an NLP task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-debugging" class="md-nav__link">
    Stopping Debugging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../processQueue/" class="md-nav__link">
        ProcessQueue
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Mapping-Pipeline
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Mapping-Pipeline" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Mapping-Pipeline
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../MappingPipeline/about/" class="md-nav__link">
        About
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../MappingPipeline/uploading-scan-report/" class="md-nav__link">
        Uploading a Report
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../MappingPipeline/nlp-processing/" class="md-nav__link">
        NLP Processing
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../MappingPipeline/mapping-rules/" class="md-nav__link">
        Mapping Rules
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../MappingPipeline/API/" class="md-nav__link">
        API
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        CO-CONNECT Tools
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="CO-CONNECT Tools" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          CO-CONNECT Tools
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/source_code/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      <label class="md-nav__link" for="__nav_4_2">
        CommonDataModel
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="CommonDataModel" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          CommonDataModel
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/CommonDataModel/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" type="checkbox" id="__nav_4_2_2" >
      
      <label class="md-nav__link" for="__nav_4_2_2">
        Tables
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tables" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_2">
          <span class="md-nav__icon md-icon"></span>
          Tables
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/Common/" class="md-nav__link">
        Common
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/Person/" class="md-nav__link">
        Person
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/ConditionOccurrence/" class="md-nav__link">
        Condition Occurrence
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/Measurement/" class="md-nav__link">
        Measurement
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/Observation/" class="md-nav__link">
        Observation
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      <label class="md-nav__link" for="__nav_4_3">
        ETL
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="ETL" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          ETL
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../CoConnectTools/source_code/notebooks/Introduction%20-%20Using%20the%20ETLTool/" class="md-nav__link">
        Workbook Example
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-functions-basics" class="md-nav__link">
    Azure Functions Basics
  </a>
  
    <nav class="md-nav" aria-label="Azure Functions Basics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#azure-functions-in-co-connect" class="md-nav__link">
    Azure Functions in Co-Connect
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-functions-queues" class="md-nav__link">
    Azure Functions Queues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-azure-functions-locally" class="md-nav__link">
    Running Azure Functions Locally
  </a>
  
    <nav class="md-nav" aria-label="Running Azure Functions Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#running-an-nlp-task" class="md-nav__link">
    Running an NLP task
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stopping-debugging" class="md-nav__link">
    Stopping Debugging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>LocalFunctions</h1>
                
                <h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Running Azure Functions locally is a little involved; this guide has been written to get you up and running with Azure CLI and Functions. Note that this guide assumes you're using VSCode. All of the functionality described here can be replicated outside of VSCode (in Azure CLI) but instructions for doing so are not detailed in this guide.</p>
<blockquote>
<p>Note that this guide is not intended to demonstrate how to create an Azure Function from scratch. Its purpose is to show you how to run pre-coded Functions.</p>
</blockquote>
<p>To follow this guide you need to install <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure CLI</a>.</p>
<h2 id="azure-functions-basics">Azure Functions Basics<a class="headerlink" href="#azure-functions-basics" title="Permanent link">&para;</a></h2>
<p>Conceptually, queue-based Azure Functions are simple to follow. A <strong><em>message</em></strong> is posted to a <strong><em>message queue</em></strong>. A Function then executes on messages within a message queue. In Co-Connect, a message is posted to a message queue as JSON but other formats are possible (e.g. XML). Here's an example message destined for the <code>scanreports</code> queue:</p>
<div class="highlight"><pre><span></span><code>{
  &quot;scan_report_id&quot;: 105, 
  &quot;blob_name&quot;: &quot;GOSH_CoStar_WhiteRabbit_MetaData_V24_T29kygl.xlsx&quot;
}
</code></pre></div>
<p>And here is an example message destined for the <code>nlpqueue</code> queue:</p>
<div class="highlight"><pre><span></span><code>{
  &quot;documents&quot;: 
  [{
    &quot;language&quot;: &quot;en&quot;, 
    &quot;id&quot;: &quot;17730_field&quot;, 
    &quot;text&quot;: &quot;The patient has a fever&quot;
  }]
}
</code></pre></div>
<p>An <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">Azure function</a> is made up of three key files. Two are kept in the function's directory (which itself lives within Co-Connect's root directory) and define what and how the function should run:</p>
<ol>
<li><code>init.py</code> - This contains the function's logic. The method <code>main()</code> should be present for the function to execute.</li>
<li><code>function.json</code> - This tells Azure what type of function you're developing and also what queue from which to pick messages up from.</li>
</ol>
<p>Another file is kept outside of the function's directory and should not be commited to Git:</p>
<ol>
<li><code>local.settings.json</code> - Contains environment variables for your function. It must be present to run Azure functions locally. Contact a member of the development team to get all keys and connection strings for this file. For reference, a local.settings.json file looks like this:</li>
</ol>
<p><div class="highlight"><pre><span></span><code>{
  &quot;IsEncrypted&quot;: false,
  &quot;Values&quot;: {
    &quot;AzureWebJobsStorage&quot;: &quot;REDACTED,
    &quot;FUNCTIONS_WORKER_RUNTIME&quot;: &quot;python&quot;,
    &quot;STORAGE_CONN_STRING&quot;: &quot;REDACTED&quot;,
    &quot;NLP_API_KEY&quot;: &quot;REDACTED&quot;,
    &quot;APP_URL&quot;: &quot;REDACTED&quot;,
    &quot;AZ_FUNCTION_KEY&quot;: &quot;REDACTED&quot;,
    &quot;SCAN_REPORT_QUEUE_NAME&quot;: &quot;scanreports-local&quot;,
    &quot;NLP_QUEUE_NAME&quot;: &quot;nlpqueue-local&quot;

  }
}
</code></pre></div>
You only need to have 1 <code>local.settings.json</code> file for all functions within the Co-Connect project. Note, however, that it should be updated with extra queue names if/when the project requires them.</p>
<h3 id="azure-functions-in-co-connect">Azure Functions in Co-Connect<a class="headerlink" href="#azure-functions-in-co-connect" title="Permanent link">&para;</a></h3>
<p>As of July 2021, the Co-Connect project has two different Azure Functions: one for processing scan reports (called <code>ProcessQueue</code> which posts to the message queue called <code>scanreports</code>), another to run the NLP service (called <code>NLPQueue</code> which posts to the message queue called <code>nlpqueue</code>). The code for these functions lives in the directories ProcessQueue and NLPQueue, respectively.</p>
<h2 id="azure-functions-queues">Azure Functions Queues<a class="headerlink" href="#azure-functions-queues" title="Permanent link">&para;</a></h2>
<p>For each process (NLP and Scan Reports), we have two queues each - a 'local' queue and a 'live' queue (for a total of 4 unique queues.) As environment variables, they are encoded as:</p>
<h5 id="local-queues">Local queues<a class="headerlink" href="#local-queues" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>NLP_QUEUE_NAME=nlpqueue-local
SCAN_REPORT_QUEUE_NAME=scanreports-local
</code></pre></div>
<h5 id="deployed-queues">Deployed queues<a class="headerlink" href="#deployed-queues" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code>NLP_QUEUE_NAME=nlpqueue
SCAN_REPORT_QUEUE_NAME=scanreports
</code></pre></div>
<p>The purpose of the local queues is that, when developing locally, messages are sent only to a 'local' queue. This stops 'development' messages from posting to the 'live' message queue.</p>
<p>These environment variables which control where messages are sent must be maintained in the following locations:</p>
<ol>
<li><code>local.settings.json</code> - A local file to hold Azure Function environment variables. Should point to 'local' (e.g. <code>NLP_QUEUE_NAME=nlpqueue-local</code>). To reiterate, this file must not be tracked on Github, otherwise secrets will be exposed!</li>
<li>Within the Azure Function App. Env Vars need to be set within the Azure Portal to the 'live' vars. Speak to Sam Cox about adding vars on the Azure Portal.</li>
<li>Within the CCOM webapp, the <code>.env</code> file must include variables for 'local' on your local machine and set to 'live' variables on App Service.</li>
</ol>
<h2 id="running-azure-functions-locally">Running Azure Functions Locally<a class="headerlink" href="#running-azure-functions-locally" title="Permanent link">&para;</a></h2>
<p>Because Azure Functions are cloud-based, it's somewhat of a misnomer to talk of running an Azure Function completely 'locally'. In reality, you're still posting to a message queue in the cloud, even when developing locally. However, Azure CLI--when running in debug mode (more on this later)--will 'hijack' the messages in the message queue (depending on how you've set the environment vairables in <code>local.settings.json</code> and <code>.env</code>) and allow you to process them with the code you're developing locally.</p>
<p>To start debugging locally in VSCode you must first ensure that CCOM is up and running locally (<a href="https://github.com/CO-CONNECT/mapping-pipeline#readme">see here for building and running the Co-Connect Docker image</a>). Once your local server is running, you can start Azure Function's debugging mode by clicking: </p>
<p>Run (top toolbar) -&gt; Start Debugging</p>
<p>After a few seconds, you'll see something like the following printed to the debugging terminal that's started when you run debugging:</p>
<p><div class="highlight"><pre><span></span><code>&gt; Executing task: . .venv/bin/activate &amp;&amp; func host start &lt;

Found Python version 3.9.5 (python3).

Azure Functions Core Tools
Core Tools Version:       3.0.3477 Commit hash: 5fbb9a76fc00e4168f2cc90d6ff0afe5373afc6d  (64-bit)
Function Runtime Version: 3.0.15584.0

[2021-07-02T09:34:28.929Z] Cannot create directory for shared memory usage: /dev/shm/AzureFunctions
[2021-07-02T09:34:28.929Z] System.IO.FileSystem: Access to the path &#39;/dev/shm/AzureFunctions&#39; is denied. Operation not permitted.

Functions:

        NLPQueue: queueTrigger
        ProcessQueue: queueTrigger

For detailed output, run func with --verbose flag.
[2021-07-02T09:34:32.711Z] Traceback (most recent call last):
[2021-07-02T09:34:32.711Z]   File &quot;/usr/local/Cellar/azure-functions-core-tools@3/3.0.3477/workers/python/3.9/OSX/X64/azure_functions_worker/bindings/shared_memory_data_transfer/file_accessor_unix.py&quot;, line 127, in _get_valid_mem_map_dirs
[2021-07-02T09:34:32.711Z]     os.makedirs(dir_path)
[2021-07-02T09:34:32.711Z]   File &quot;/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/os.py&quot;, line 215, in makedirs
[2021-07-02T09:34:32.711Z]     makedirs(head, exist_ok=exist_ok)
[2021-07-02T09:34:32.711Z]   File &quot;/usr/local/Cellar/python@3.9/3.9.5/Frameworks/Python.framework/Versions/3.9/lib/python3.9/os.py&quot;, line 225, in makedirs
[2021-07-02T09:34:32.711Z]     mkdir(name, mode)
[2021-07-02T09:34:32.711Z] PermissionError: [Errno 1] Operation not permitted: &#39;/dev/shm&#39;
[2021-07-02T09:34:32.812Z] Worker process started and initialized.
[2021-07-02T09:34:36.731Z] Host lock lease acquired by instance ID &#39;000000000000000000000000DC4198B8&#39;.
</code></pre></div>
You'll likely see a few errors/warnings about directories and permissions. At the time of writing this guide, it's safe to ignore these!
Note that two functions are listed as you start debugging mode: <code>NLPQueue</code> and <code>ProcessQueue</code>. These are the names of the <strong><em>directories</em></strong> which hold the function's code, not the name of the <strong><em>message queue</em></strong> which holds the function's messages. The text after the function name (queueTrigger) specifies the <em>type</em> of function it is (defined in <code>function.json</code>.) So far in Co-Connect, only queueTriggers are used. For more information on Function types, click <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">here</a>.</p>
<p>With the final console output saying 'Host lock lease acquired', you're ready to run your first Azure Functions job!</p>
<h3 id="running-an-nlp-task">Running an NLP task<a class="headerlink" href="#running-an-nlp-task" title="Permanent link">&para;</a></h3>
<p>The remainder of this guide will show what to expect to see in the debugging console if you run NLP at the field level.</p>
<ol>
<li>Navigate to a field within a scan report.</li>
<li>Ensure the field you've chosen has a meaningful description (e.g. "Patient has a cold"). If it doesn't have one, click 'Edit Field' and manually put one in.</li>
<li>Ensure that <code>pass_from_source</code> is set to <code>True</code> within the field's settings. This will cause CCOM to process the field only.</li>
<li>Click 'Run NLP'</li>
<li>After a short wait a green message banner will appear to say NLP is now running.</li>
</ol>
<p>Hop back to VSCode. After a few seconds, you should see the debugging console updating to say that it has received the message from the message queue:
<div class="highlight"><pre><span></span><code>Executing &#39;Functions.NLPQueue&#39; (Reason=&#39;New queue message detected on &#39;nlpqueue-local&#39;.&#39;, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355)
Trigger Details: MessageId: f00a438f-9bad-4110-bb8b-5278461d7bb3, DequeueCount: 1, InsertionTime: 2021-07-02T10:57:26.000+00:00
</code></pre></div>
If you have configured <code>.env</code> and <code>local.settings.json</code> correctly, you will see that the job was posted to the queue <code>nlpqueue-local</code>.</p>
<p>After some time (around 15-30 seconds), you should notice further updates to the debugging console. Due to various <code>print()</code> statements in the init.py file (remember, this holds the function's logic), the console will start logging what's occurring as the function processes the message in the message queue. First, the console shows you what message was sent to the queue:
<div class="highlight"><pre><span></span><code>MESSAGE &gt;&gt;&gt;  {&#39;id&#39;: &#39;f00a438f-9bad-4110-bb8b-5278461d7bb3&#39;, &#39;body&#39;: &#39;{&quot;documents&quot;: [{&quot;language&quot;: &quot;en&quot;, &quot;id&quot;: &quot;17569_field&quot;, &quot;text&quot;: &quot;patient has a cold&quot;}]}&#39;}
</code></pre></div>
After job submission, the <code>NLPQueue</code> function works through the stages detailed in <a href="/MappingPipeline/nlp-processing">NLP Processing</a>. Having received concept <strong><em>codes</em></strong> from the NLP API, the function looks up a standard and valid <strong><em>conceptID</em></strong> using the CCOM API. Sometimes, a concept code will be returned which doesn't have a standard and valid conceptID. In such instances you will see the following in the debugging console:
<div class="highlight"><pre><span></span><code>Concept Code C34500 not found!
</code></pre></div>
However, if a standard and valid conceptID is found, the Azure function then saves the data to the <code>ScanReportConcept</code> model. This is shown to you in the debugging console with the <code>PAYLOAD</code> print statement like so:
<div class="highlight"><pre><span></span><code>SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD10CM&#39;, &#39;nlp_concept_code&#39;: &#39;J00&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD9CM&#39;, &#39;nlp_concept_code&#39;: &#39;460&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;SNOMEDCT_US&#39;, &#39;nlp_concept_code&#39;: &#39;82272006&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
</code></pre></div>
Here, three conceptIDs were found for three different vocabularies (ICD10CM, ICD9CM and SNOWMEDCT_US). Therefore, three records are saved to <code>ScanReportConcepts</code> (hence the three <code>SAVING TO FIELD LEVEL...</code> statements)</p>
<p>After successful execution, the debug console will finally tell you that the job has finished:
<div class="highlight"><pre><span></span><code>Executed &#39;Functions.NLPQueue&#39; (Succeeded, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355, Duration=30234ms)
</code></pre></div></p>
<p>Here is a full interrupted trace of the above process:
<div class="highlight"><pre><span></span><code>Executing &#39;Functions.NLPQueue&#39; (Reason=&#39;New queue message detected on &#39;nlpqueue-local&#39;.&#39;, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355)
Trigger Details: MessageId: f00a438f-9bad-4110-bb8b-5278461d7bb3, DequeueCount: 1, InsertionTime: 2021-07-02T10:57:26.000+00:00
MESSAGE &gt;&gt;&gt;  {&#39;id&#39;: &#39;f00a438f-9bad-4110-bb8b-5278461d7bb3&#39;, &#39;body&#39;: &#39;{&quot;documents&quot;: [{&quot;language&quot;: &quot;en&quot;, &quot;id&quot;: &quot;17569_field&quot;, &quot;text&quot;: &quot;patient has a cold&quot;}]}&#39;}
Concept Code C34500 not found!
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD10CM&#39;, &#39;nlp_concept_code&#39;: &#39;J00&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;ICD9CM&#39;, &#39;nlp_concept_code&#39;: &#39;460&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
SAVING TO FIELD LEVEL...
PAYLOAD &gt;&gt;&gt; {&#39;nlp_entity&#39;: &#39;cold&#39;, &#39;nlp_entity_type&#39;: &#39;SymptomOrSign&#39;, &#39;nlp_confidence&#39;: 0.75, &#39;nlp_vocabulary&#39;: &#39;SNOMEDCT_US&#39;, &#39;nlp_concept_code&#39;: &#39;82272006&#39;, &#39;concept&#39;: 260427, &#39;object_id&#39;: &#39;17569&#39;, &#39;content_type&#39;: 15}
Executed &#39;Functions.NLPQueue&#39; (Succeeded, Id=ea27d6be-eb0b-490c-9cab-82cf2a119355, Duration=30234ms)
</code></pre></div></p>
<h3 id="stopping-debugging">Stopping Debugging<a class="headerlink" href="#stopping-debugging" title="Permanent link">&para;</a></h3>
<p>Debugging can be stopped by clicking:</p>
<p>Run (top menu) -&gt; Stop Debugging</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../.." class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Welcome
            </div>
          </div>
        </a>
      
      
        <a href="../processQueue/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              ProcessQueue
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
 
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
    
  </body>
</html>